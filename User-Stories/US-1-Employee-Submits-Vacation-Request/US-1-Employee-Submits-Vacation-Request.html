<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Story Template</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{--border:#bdbdbd;--text:#333;--muted:#666;--bg:##FFFFFF;--white:#fff;--header:#e0e0e0;}
    body{font:16px Arial;margin:20px auto;padding:20px;max-width:1200px;background:var(--bg);color:var(--text);border:2px solid #ccc;}
    h1{text-align:center;margin:0 0 18px;}
    .description{text-align:center;color:var(--muted);margin-bottom:24px;}
    .export-buttons{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin:0 0 18px;}
    .export-buttons button{padding:10px 16px;min-width:120px;border:none;border-radius:4px;background:#000;color:#fff;cursor:pointer;font-weight:700;transition:opacity .15s ease;}
    .export-buttons button:hover{opacity:.85;}
    table{width:100%;border-collapse:collapse;background:var(--white);box-shadow:0 2px 4px rgba(0,0,0,.08);font-size:13px;table-layout:fixed;margin-bottom:20px;}
    th,td{border:1px solid var(--border);padding:8px 10px;vertical-align:top;word-wrap:break-word;overflow-wrap:break-word;word-break:normal;line-height:1.4;hyphens:auto;}
    th{background:#f0f0f0;text-align:left;font-weight:600;white-space:normal;}
    tr:nth-child(even) td:not(.category){background:#fafafa;}
    .category{background:var(--header);font-weight:700;text-transform:uppercase;text-align:center;padding:10px;}
    td > *:first-child{margin-top:0;}
    td > *:last-child{margin-bottom:0;}
    .note{font-size:13px;color:var(--muted);margin-top:12px;}
    @media(max-width:768px){
      body{margin:10px;padding:14px;}
      .export-buttons{gap:8px;}
      .export-buttons button{width:100%;max-width:260px;}
      table{font-size:12px;margin-bottom:15px;}
      th,td{padding:6px 8px;}
    }
    @media(max-width:480px){
      table{display:block;overflow-x:auto;}
      .category{white-space:normal;}
    }
    @media print{
      .export-buttons{display:none;}
      body{border:none;margin:0;padding:8px;}
      table{page-break-inside:auto;}
      tr{page-break-inside:avoid;}
      thead{display:table-header-group;}

  #pageTitle, #pageDescription { display: none; }
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">User Story Template</h1>
  <p class="description" id="pageDescription">Dynamic user story template driven by JSON data</p>
  <div class="export-buttons">
    <button onclick="exportUserStoryToCSV()">Export User Story (CSV)</button>
    <button onclick="exportUserStoryToPDF()">Export User Story (PDF)</button>
    <button onclick="window.print()">Print</button>
  </div>
  <div id="userStoryTableContainer"></div>

  <script>

    
const userStoryData = {
  title: "Employee Submits Vacation Request",
  description: "Core functionality for employees to request and adjust vacations before submission. This feature provides a dedicated screen accessible via web and mobile platforms for employees to submit their leave requests for multi-level approval.",

  sections: {
    "Summary": [
      ["ID", "**UC-1**"],
      ["Epic", "Vacation Request Management"], // This use case (UC-1) is a primary component of the "Vacation Request Management" functional requirement (FR-001)
      ["Title", "Employee Submits Vacation Request"],
      ["Priority", "High"], // Inferred as a core functionality for the vacation management system
      ["Status", "**In Progress**"]
    ],

    "User Story": [
      "**As an Employee, I want to submit a vacation request and route it to my manager for approval, so that I can schedule my time off and receive official acknowledgment.**"
    ],

    "Trigger": [
      ["Trigger", "Employee initiates a new vacation request in the portal."]
    ],

    "Acceptance Criteria": {
      headers: ["#", "Criteria"],
      rows: [
        ["1", "Given the employee navigates to 'Request Vacation', when the system displays the vacation request form (Screen 1), then it includes **auto-filled, read-only fields for Employee Name and Employee ID**, **mandatory input fields for Vacation Type (with 'Annual' | 'Sick' options), Start Date, and End Date**, an **auto-calculated, read-only field for Period (Days)**, an **optional text area for Notes**, and a **File Upload Area for Attachments**. The form also displays the **current leave balance**."],
        ["2", "Given the employee enters a **Start Date** and **End Date**, when the system performs real-time validation, then the **Start Date must not be in the past**, and the **End Date must be strictly after the Start Date**."],
        ["3", "Given **'Sick' leave is selected as the Vacation Type**, when the employee attempts to submit the request, then the system **requires a medical certificate attachment** for successful submission."],
        ["4", "Given the **requested days do not exceed the employee's available leave balance** and all other validations pass, when the employee clicks 'Submit', then the system **saves the request**, **assigns a unique Request ID**, and **sets its initial status to 'Pending Approval'**."],
        ["5", "Given an **insufficient leave balance** for the requested period, when the employee attempts to submit the request, then the system **blocks submission** and displays an error message (e.g., MSG-102)."],
        ["6", "Given the employee selects **dates that overlap an existing vacation request** for the same employee, when they proceed with the request, then the system **warns the employee about the overlap** and allows them to **confirm or adjust** the dates."],
        ["7", "Given the employee is identified as a **trainee**, when they attempt to submit a vacation request, then the system **blocks the request submission**."],
        ["8", "When the employee clicks 'Submit', then the submission operation should complete **within 120 seconds**."],
        ["9", "Given the **HR database is unavailable** during submission, when the employee clicks 'Submit', then the system **shows an error** and prompts the employee to retry later."]
      ]
    },

    "Notes": [
      ["Dependencies", "The employee must be **authenticated** in the HR system and possess a **non-zero leave balance** for a request to be submitted. The system relies on **Employee Master Data** and **Vacation Types Master Data** for accurate information and policy enforcement. The system integrates with existing HR systems."],
      ["Remark", "This use case is designed for **full-time Muslim Saudi employees, excluding trainees**. Requests can be **modified before submission**, but **not afterwards**. Upon successful submission, the request is stored with a 'Pending Approval' status, the manager is notified, and the employee can track the status from their dashboard. The annual leave entitlement is **21 days**, increasing to **30 days for employees with over 10 years of service or those aged 50 and above**. Unused vacation days are **forfeited annually** without carryover or compensation. Only **Annual and Sick leave types** are supported."]
    ]
  }
};


const FIRST_COL_WIDTH = '6%';
function renderUserStoryTable(data){const c=document.getElementById('userStoryTableContainer');c.innerHTML='';document.getElementById('pageTitle').textContent=data.title;document.getElementById('pageDescription').textContent=data.description;document.title=data.title;let maxCols=5;Object.values(data.sections).forEach(s=>{if(s&&s.headers)maxCols=Math.max(maxCols,s.headers.length)});const t=document.createElement('table'),tb=document.createElement('tbody');const formatText=txt=>txt?txt.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>'):'';Object.entries(data.sections).forEach(([title,content])=>{if(!content||(Array.isArray(content)&&content.length===0)||(content.headers&&(!content.rows||content.rows.length===0))){return;}const hr=document.createElement('tr'),hc=document.createElement('td');hc.className='category';hc.colSpan=maxCols;hc.innerHTML=formatText(title);hr.appendChild(hc);tb.appendChild(hr);if(Array.isArray(content)){content.forEach(item=>{const tr=document.createElement('tr');if(Array.isArray(item)){const kc=document.createElement('td');kc.innerHTML=formatText(item[0]);kc.style.width=FIRST_COL_WIDTH;tr.appendChild(kc);const vc=document.createElement('td');vc.colSpan=maxCols-1;vc.innerHTML=formatText(item[1]);tr.appendChild(vc);}else{const nc=document.createElement('td');nc.innerHTML=content.indexOf(item)+1;nc.style.width=FIRST_COL_WIDTH;tr.appendChild(nc);const vc=document.createElement('td');vc.colSpan=maxCols-1;vc.innerHTML=formatText(item);tr.appendChild(vc);}tb.appendChild(tr);});}else if(content.headers&&content.rows){const hr2=document.createElement('tr'),dist=calculateColumnDistribution(content,maxCols);content.headers.forEach((h,i)=>{const th=document.createElement('th');th.innerHTML=formatText(h);if(i===0)th.style.width=FIRST_COL_WIDTH;else th.colSpan=dist[i]||1;hr2.appendChild(th);});tb.appendChild(hr2);content.rows.forEach(r=>{const tr=document.createElement('tr');r.forEach((cell,i)=>{const td=document.createElement('td');td.innerHTML=formatText(cell);if(i===0)td.style.width=FIRST_COL_WIDTH;else td.colSpan=dist[i]||1;tr.appendChild(td);});if(r.length<content.headers.length){const lc=tr.cells[tr.cells.length-1];let rem=0;for(let i=r.length;i<content.headers.length;i++)rem+=dist[i]||1;lc.colSpan+=rem;}tb.appendChild(tr);});}});const colgroup=document.createElement('colgroup');for(let i=0;i<maxCols;i++){const col=document.createElement('col');col.style.width=i===0?FIRST_COL_WIDTH:`${Math.floor((100-parseInt(FIRST_COL_WIDTH))/(maxCols-1))}%`;colgroup.appendChild(col);}t.appendChild(colgroup);t.appendChild(tb);c.appendChild(t);}
function calculateColumnMetrics(c,i){if(!c||!c.headers||!c.rows)return{avgLength:0,maxLength:0,variance:0};const h=c.headers[i],lens=c.rows.map(r=>r[i]?r[i].toString().length:0);lens.push(h.length*0.2);const avg=lens.reduce((a,b)=>a+b,0)/lens.length;const variance=lens.reduce((a,b)=>a+Math.pow(b-avg,2),0)/lens.length;return{avgLength:avg,maxLength:Math.max(...lens),variance};}
function normalizeToSpans(v,t,min=1,maxR=0.4){const total=v.reduce((a,b)=>a+b,0),maxS=Math.floor(t*maxR);let spans=v.map(x=>Math.max(min,Math.min(maxS,Math.round((x/total)*t))));let sum=spans.reduce((a,b)=>a+b,0);while(sum!==t){const diff=t-sum;if(diff>0){const idx=v.map((val,i)=>({val,i})).filter(({i})=>spans[i]<maxS).sort((a,b)=>b.val-a.val)[0]?.i;if(idx!==undefined)spans[idx]++;}else{const idx=v.map((val,i)=>({val,i})).filter(({i})=>spans[i]>min).sort((a,b)=>a.val-b.val)[0]?.i;if(idx!==undefined)spans[idx]--;}sum=spans.reduce((a,b)=>a+b,0);}return spans;}
function calculateColumnDistribution(c,maxC){if(!c||!c.headers||!c.rows)return Array(maxC).fill(1);const m=c.headers.map((_,i)=>calculateColumnMetrics(c,i)),w=m.map(x=>Math.max(5,x.avgLength)*Math.max(0.8,1-Math.sqrt(x.variance)/100));let spans=normalizeToSpans(w,maxC,1,calculateMaxSpanRatio(m,c.headers.length));if(c.headers.length===2){spans[0]=1;spans[1]=maxC-1;}else spans[0]=1;return spans;}
function calculateMaxSpanRatio(m,t){const base=1/t,max=Math.max(...m.map(x=>x.avgLength)),min=Math.min(...m.map(x=>x.avgLength)),ratio=max/(min||1);return Math.min(0.6,Math.max(0.25,base*(1+Math.min(3,ratio/2))));}
function exportUserStoryToCSV(){const s=[];s.push(['Title',userStoryData.title],['Description',userStoryData.description],[]);Object.entries(userStoryData.sections).forEach(([st,c])=>{s.push([st.toUpperCase()]);if(Array.isArray(c)){c.forEach(i=>{if(Array.isArray(i))s.push([i[0],i[1]]);else s.push(['â€¢',i]);});}else if(c.headers&&c.rows){s.push(c.headers);c.rows.forEach(r=>s.push(r));}s.push([]);});const csv=s.map(r=>r.map(cell=>cell?`"${cell.toString().replace(/"/g,'""')}"`:'').join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='user-story.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
function exportUserStoryToPDF(){const{jsPDF}=window.jspdf,doc=new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});doc.setProperties({title:userStoryData.title,subject:userStoryData.description,author:'User Story Generator',creator:'User Story Generator'});const m=20,w=doc.internal.pageSize.width,defaults={styles:{fontSize:8,cellPadding:3,lineWidth:.1,lineColor:[189,189,189]},margin:{left:m,right:m},theme:'grid'};doc.autoTable({startY:m,head:[[{content:userStoryData.title,styles:{halign:'center',fontStyle:'bold'}}]],body:[[{content:userStoryData.description,styles:{halign:'center'}}]],...defaults});let y=doc.lastAutoTable.finalY+5;Object.entries(userStoryData.sections).forEach(([st,c])=>{doc.autoTable({startY:y,body:[[{content:st,styles:{fillColor:[224,224,224],fontStyle:'bold',halign:'center',textTransform:'uppercase'}}]],...defaults});y=doc.lastAutoTable.finalY;if(Array.isArray(c)){if(c.length&&Array.isArray(c[0])){doc.autoTable({startY:y,body:c.map(([k,v])=>[{content:k,styles:{cellWidth:100}},v]),columnStyles:{0:{fillColor:[250,250,250]}},...defaults});}else{doc.autoTable({startY:y,body:c.map(i=>[i]),...defaults});}}else if(c.headers&&c.rows){doc.autoTable({startY:y,head:[c.headers],body:c.rows,headStyles:{fillColor:[240,240,240],textColor:[0,0,0],fontStyle:'bold'},alternateRowStyles:{fillColor:[250,250,250]},...defaults});}y=doc.lastAutoTable.finalY+2;});const pages=doc.internal.getNumberOfPages();for(let i=1;i<=pages;i++){doc.setPage(i);doc.setFontSize(7);doc.text(`Page ${i} of ${pages}`,w-m-40,doc.internal.pageSize.height-10);}doc.save('user-story.pdf');}
document.addEventListener('DOMContentLoaded',()=>renderUserStoryTable(userStoryData));
  </script>
</body>
</html>
